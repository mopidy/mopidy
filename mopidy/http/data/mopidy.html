<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Mopidy HTTP frontend</title>
    <link rel="stylesheet" type="text/css" href="mopidy.css">
</head>
<body>
<div class="box focus">
    <h1>Mopidy HTTP&nbsp;frontend</h1>

    <p>This web server is a part of the music server Mopidy. To learn more
        about Mopidy, please visit <a
                href="http://www.mopidy.com/">www.mopidy.com</a>.</p>
</div>

<div class="box">
    <h2>WebSocket endpoint</h2>

    <p>Mopidy has a WebSocket endpoint at <tt>/mopidy/ws/</tt>. You can use
        this end point to access Mopidy's full API, and to get notified about
        events happening in Mopidy.</p>
</div>

<div class="box">
    <h2>Interactive API Explorer</h2>

    <div ng-app="api">
        <div ng-controller="MainCtrl">

            <ul id="toc">
                <li ng-repeat="method in methods_keys track by $index">
                    <a ng-href="#{{method}}">
                        {{method}}
                    </a>
                </li>
            </ul>
            <h3>Methods</h3>
            <ul>
                <li id="{{method}}"
                    ng-repeat="method in methods_keys track by $index">
                    <a
                            ng-href="#{{method}}"><i>instance.{{method}}({{getParams(method)
                        }})</i></a>
                    <h5>Curl</h5>
                    <pre>{{getCurl(method)
                        }}<a ng-click="run()" href="#">Run</a></pre>
                    <h5>Description</h5>
                    <article
                            ng-bind-html="getIt(method, 'description') | htmlify"></article>
                </li>
            </ul>
        </div>
    </div>
</div>

<div class="box">
    <h2>Events</h2>

    <p>Here you can see events arriving from Mopidy in real time:</p>

    <pre id="ws-console"></pre>

    <p>Nothing to see? Try playing a track using your MPD client.</p>
</div>

<div class="box focus">
    <h2>Documentation</h2>

    <p>For more information, please refer to the Mopidy documentation at
        <a href="http://docs.mopidy.com/">docs.mopidy.com</a>.</p>
</div>
<script src="mopidy.js" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.8/angular.min.js"
        type="text/javascript"></script>
<script src="https://code.angularjs.org/1.3.0-beta.8/angular-sanitize.min.js"
        type="text/javascript"></script>
<script type="text/javascript">
    angular.module('api', [
        'controllers'
    ])
    angular.module('controllers', [])
            .controller('MainCtrl',function ($scope) {
                var mopidy = new Mopidy();
                mopidy.on("state:online", function () {
                    mopidy._send({method: "core.describe"}).then(function (data) {
                        window.a = data;
                        $scope.$apply(function () {
                            $scope.methods = data;
                            $scope.methods_keys = Object.keys(data).map(function (item) {
                                return String(item).replace("core.", "");
                            }).sort();
                        });
                    });

                });
                $scope.getCurl = function (method) {
                    return 'curl -X POST -H Content-Type:application/json' +
                            ' -d \'{\n  "method": "core.' + method + '",\n  ' +
                            '"jsonrpc": "2.0",\n  "id": 1\n}\' ' +
                            document.location.origin + '/mopidy/rpc';
                }
                $scope.getParams = function (method) {
                    return $scope.getIt(method, 'params').map(function (item) {
                        return item.name;
                    }).join(', ');
                }
                $scope.getIt = function (method, key) {
                    var val = $scope.methods["core." + method][key];
                    return val || 'Missing';
                }
            }).filter('htmlify', ['$sce', function ($sce) {
                return function (input) {
                    if (!input) {
                        return '';
                    }
                    var text = input.
                                    replace(/&/g, '&amp;').
                                    replace(/</g, '&lt;').
                                    replace(/>/g, '&gt;').
                                    replace(/'/g, '&#39;').
                                    replace(/"/g, '&quot;').
                                    replace(/``(\S+)``/g, "<b>$1</b>").
                                    replace(/:param (\w+) (\w+):/g, "<b title=\"$1\">$2</b>").
                                    replace(/:param (\w+):/g, "<b>$1</b>").
                                    replace(/:attr:`(\w+)`/g, "<b>$1</b>").
                                    replace(/:meth:`([~\.\w]+)\(?\)?`/g, "<code title='method'>$1</code>").
                                    replace(/    (.+)/g, "<pre>$1</pre>").replace(/<\/pre>(\s?)+<pre>/gim, "\n").
                                    replace(/:type (\w+): (\w+)/g, "<i title=\"$2\">(type)</i>").
                                    replace(/:type (\w+):/g, "<i title=\"$1\">($1)</i>").
                                    replace(/:class:`([~\.\w]+)`/g, "<code title=\"class\">$1</code>").
                                    replace(/``\[\\([\[\\]:\.\w]+)\]``/g, "<b>$1</b>").
                                    replace(/:rtype: (\w+)/g, "<i>$1</i>").
                                    replace(/:rtype:/g, "return")
                            ;

                    var output = '';
                    angular.forEach(text.split("\n\n"), function (paragraph, key) {
                        output += '<p>' + paragraph + '</p>';
                    });
                    return $sce.trustAsHtml(output);
                };
            }]);
    var ws = new WebSocket("ws://" + document.location.host + "/mopidy/ws/");
    ws.onmessage = function (message) {
        var console = document.getElementById('ws-console');
        var newLine = (new Date()).toLocaleTimeString() + ": " +
                message.data + "\n";
        console.innerHTML = newLine + console.innerHTML;
    };
</script>
</body>
</html>
